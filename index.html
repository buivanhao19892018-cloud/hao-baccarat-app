<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070b14" />
  <title>Bùi Hào — Baccarat ULTRA AI v2 (Cards • Pair • Long • Phase)</title>
  <style>
    :root{
      --bg:#070b14;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --b:#22c55e;   /* banker */
      --p:#60a5fa;   /* player */
      --t:#fbbf24;   /* tie */
      --red:#fb7185;
      --shadow:0 18px 50px rgba(0,0,0,.55);
      --r:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1100px 700px at 18% 0%, #142a53 0%, var(--bg) 58%) fixed;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .hero{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    h1{margin:0;font-size:20px;font-weight:1000}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .tag{display:inline-block;margin-left:8px;padding:5px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);font-size:12px;font-weight:900;color:rgba(255,255,255,.85)}
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:0;cursor:pointer;user-select:none;
      padding:18px 18px;border-radius:18px;
      font-weight:1100;font-size:18px;
      min-width:150px;
      color:#061018;
      box-shadow:0 12px 28px rgba(0,0,0,.25);
    }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.b{background:var(--b)}
    .btn.p{background:var(--p)}
    .btn.t{background:var(--t)}
    .btn.ghost{background:rgba(255,255,255,.10);border:1px solid var(--stroke);color:var(--txt);min-width:130px}
    .btn.danger{background:var(--red);color:#fff}
    .btn.small{padding:12px 14px;font-size:14px;min-width:auto;border-radius:16px}

    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
    @media(max-width:920px){.grid{grid-template-columns:repeat(2,1fr)} .btn{min-width:140px}}
    @media(max-width:420px){.btn{min-width:120px;font-size:16px;padding:16px 14px}}

    .stat{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
    }
    .k{color:var(--muted);font-size:12px;font-weight:900}
    .v{margin-top:6px;font-size:24px;font-weight:1100}
    .mini{margin-top:6px;color:var(--muted);font-size:12px;line-height:1.35}

    .two{display:grid;grid-template-columns:1.2fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:920px){.two{grid-template-columns:1fr}}

    .box{
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
    }
    .panelTitle{font-weight:1100;color:var(--muted);font-size:12px;margin-bottom:8px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1000;
      font-size:13px;
      color:rgba(255,255,255,.88);
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
    .dot.b{background:var(--b)}
    .dot.p{background:var(--p)}
    .dot.t{background:var(--t)}

    .handGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:820px){.handGrid{grid-template-columns:1fr}}

    .hand{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
    }
    .handHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .handHead b{font-size:14px}
    .pillBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:10px 12px;border-radius:14px;
      font-weight:1000;cursor:pointer;
    }
    .cards{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .cardTag{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:1100;
      min-width:56px;
      text-align:center;
    }

    .badge{
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:1100;font-size:12px;
      color:rgba(255,255,255,.90);
    }
    .badge.good{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.14)}
    .badge.warn{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.14)}
    .badge.neu{border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.14)}
    .badge.play{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.20)}
    .badge.wait{border-color:rgba(251,191,36,.45);background:rgba(251,191,36,.20)}
    .badge.skip{border-color:rgba(251,113,133,.45);background:rgba(251,113,133,.20)}

    .bigStatus{font-size:34px;font-weight:1200;letter-spacing:.5px}
    .meter{margin-top:10px}
    .meterRow{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .bar{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);margin-top:6px}
    .bar i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#eab308,#ef4444)}

    .history{
      margin-top:10px;
      display:flex;flex-wrap:wrap;gap:8px;
    }
    .h{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 12px;
      font-weight:1100;
      min-width:54px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .h.b{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.28);color:#082014}
    .h.p{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.28);color:#071a31}
    .h.t{background:rgba(251,191,36,.18);border-color:rgba(251,191,36,.28);color:#3a2a00}

    .footer{color:rgba(255,255,255,.55);font-size:12px;text-align:center;padding:6px 0}

    dialog{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(10,14,24,.96);
      color:var(--txt);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow);
      max-width:560px;
      width:92vw;
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlgTitle{font-weight:1100;margin:0 0 10px}
    .dlgRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sel{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 12px;border-radius:14px;
      font-weight:1000;
      min-width:160px;
    }
    .dlgBtns{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .reasons{margin-top:8px;color:rgba(255,255,255,.78);font-size:13px;line-height:1.35}
    .reasons b{color:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>Bùi Hào — Baccarat <span class="tag">ULTRA AI v2 · FULL PRO</span></h1>
      <div class="sub">
        Nhập ván + nhập lá bài. App tự nhận <b>Pair</b> (2 lá đầu) + <b>Long Bảo</b> (Natural 8/9).
        AI đọc nhịp theo <b>Last12 + Last30</b>, có <b>Phase</b> và <b>PLAY/WAIT/SKIP</b>.
      </div>
    </div>

    <div class="card">
      <div class="btnRow">
        <button class="btn b" id="winB">BANKER WIN</button>
        <button class="btn p" id="winP">PLAYER WIN</button>
        <button class="btn t" id="winT">TIE</button>
        <button class="btn ghost" id="undo">UNDO</button>
        <button class="btn danger" id="reset">RESET</button>
      </div>

      <div class="grid">
        <div class="stat">
          <div class="k">Banker</div>
          <div class="v" id="cB">0</div>
          <div class="mini">B thắng</div>
        </div>
        <div class="stat">
          <div class="k">Player</div>
          <div class="v" id="cP">0</div>
          <div class="mini">P thắng</div>
        </div>
        <div class="stat">
          <div class="k">Tie</div>
          <div class="v" id="cT">0</div>
          <div class="mini">Hòa</div>
        </div>
        <div class="stat">
          <div class="k">Shoe</div>
          <div class="v" id="shoe">1</div>
          <div class="mini">New Shoe ở dưới</div>
        </div>
      </div>

      <div class="two">
        <div class="box">
          <div class="panelTitle">AI STATUS (FULL PRO)</div>
          <div class="row" style="align-items:flex-end">
            <div>
              <div class="bigStatus" id="aiActionText">WAIT</div>
              <div class="row" style="margin-top:8px">
                <span class="badge neu" id="aiPhase">PHASE: —</span>
                <span class="badge neu" id="aiLean">LEAN: NONE</span>
              </div>
            </div>
            <div style="flex:1;min-width:240px">
              <div class="row" style="justify-content:flex-end">
                <span class="badge" id="aiConf">Conf: 0%</span>
                <span class="badge" id="aiNoise">Noise: 0%</span>
                <span class="badge" id="aiEdge">Edge: 0%</span>
              </div>

              <div class="meter">
                <div class="meterRow"><span>Confidence</span><b id="aiConfVal">0%</b></div>
                <div class="bar"><i id="confBar"></i></div>
              </div>
              <div class="meter">
                <div class="meterRow"><span>Noise</span><b id="aiNoiseVal">0%</b></div>
                <div class="bar"><i id="noiseBar"></i></div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="chip"><span class="dot b"></span> B% (B/P) <b id="bpB">-</b></div>
            <div class="chip"><span class="dot p"></span> P% (B/P) <b id="bpP">-</b></div>
            <div class="chip"><span class="dot t"></span> Tie% <b id="tiePct">-</b></div>
            <div class="chip">Alt(12): <b id="alt12">-</b></div>
            <div class="chip">Entropy(12): <b id="ent12">-</b></div>
            <div class="chip">Shock(20): <b id="shock20">-</b></div>
          </div>

          <div class="reasons" id="aiReasons">
            <b>Gợi ý:</b> Nhập đủ 8–12 ván B/P để AI ổn định.
          </div>
        </div>

        <div class="box">
          <div class="panelTitle">Ván gần nhất + Lá bài</div>

          <div class="row">
            <span class="badge neu">KQ: <b id="lastRes">-</b></span>
            <span class="badge neu">B Pair: <b id="lastBP">-</b></span>
            <span class="badge neu">P Pair: <b id="lastPP">-</b></span>
            <span class="badge neu">Long: <b id="lastLB">-</b></span>
          </div>

          <div class="handGrid" style="margin-top:10px">
            <div class="hand">
              <div class="handHead">
                <b>Banker Cards</b>
                <button class="pillBtn" id="editB">Nhập/Sửa</button>
              </div>
              <div class="cards" id="cardsB"></div>
              <div class="row" style="margin-top:10px">
                <span class="badge neu">Total: <b id="totB">0</b></span>
                <span class="badge neu" id="natB">—</span>
              </div>
            </div>

            <div class="hand">
              <div class="handHead">
                <b>Player Cards</b>
                <button class="pillBtn" id="editP">Nhập/Sửa</button>
              </div>
              <div class="cards" id="cardsP"></div>
              <div class="row" style="margin-top:10px">
                <span class="badge neu">Total: <b id="totP">0</b></span>
                <span class="badge neu" id="natP">—</span>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:10px;justify-content:space-between">
            <button class="btn ghost small" id="newShoe">NEW SHOE</button>
            <button class="btn ghost small" id="export">EXPORT</button>
            <button class="btn ghost small" id="clear">CLEAR LƯU MÁY</button>
          </div>

          <div class="mini" style="margin-top:8px">
            Tip chống “bản cũ”: mở link kèm <b>?v=ultraAIv2</b> hoặc tab ẩn danh.
          </div>
        </div>
      </div>

      <div class="box" style="margin-top:10px">
        <div class="panelTitle">History (chạm để xóa đúng ván)</div>
        <div class="history" id="hist"></div>
        <div class="mini">Chạm 1 ô để xóa đúng ván đó.</div>
      </div>

      <div class="footer">Bùi Hào — ULTRA AI v2 • Mobile First • Phase Engine • Anti-trap Gate</div>
    </div>
  </div>

  <!-- Dialog nhập bài -->
  <dialog id="dlg">
    <h3 class="dlgTitle" id="dlgTitle">Nhập lá bài</h3>
    <div class="dlgRow">
      <select class="sel" id="which">
        <option value="B">Banker</option>
        <option value="P">Player</option>
      </select>
      <select class="sel" id="cardCount">
        <option value="2">2 lá</option>
        <option value="3">3 lá</option>
      </select>
    </div>
    <div class="dlgRow" style="margin-top:10px">
      <select class="sel" id="c1"></select>
      <select class="sel" id="c2"></select>
      <select class="sel" id="c3"></select>
    </div>
    <div class="dlgBtns">
      <button class="pillBtn" id="dlgCancel">Hủy</button>
      <button class="pillBtn" id="dlgSave">Lưu</button>
    </div>
  </dialog>

<script>
(() => {
  const KEY = "hao_ultra_ai_v2";
  const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const rankValue = (r) => {
    if (r==="A") return 1;
    if (r==="J"||r==="Q"||r==="K"||r==="10") return 0;
    return parseInt(r,10);
  };
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const $ = (id)=>document.getElementById(id);

  let state = load() || { shoe: 1, hands: [] };
  // hand: {res:'B'|'P'|'T', shoe:number, bpPair:boolean, ppPair:boolean, long:boolean, cardsB:string[], cardsP:string[]}

  // ---------- UI refs
  const winB=$("winB"), winP=$("winP"), winT=$("winT"), undo=$("undo"), reset=$("reset");
  const editB=$("editB"), editP=$("editP"), newShoe=$("newShoe"), exportBtn=$("export"), clearBtn=$("clear");
  const dlg=$("dlg"), dlgTitle=$("dlgTitle"), which=$("which"), cardCount=$("cardCount");
  const c1=$("c1"), c2=$("c2"), c3=$("c3"), dlgCancel=$("dlgCancel"), dlgSave=$("dlgSave");

  // populate selects
  function fillCardSelect(sel){
    sel.innerHTML="";
    for(const r of ranks){
      const o=document.createElement("option");
      o.value=r; o.textContent=r;
      sel.appendChild(o);
    }
  }
  fillCardSelect(c1); fillCardSelect(c2); fillCardSelect(c3);

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||""); }catch(e){ return null; } }

  function currentHand(){
    return state.hands[state.hands.length-1] || null;
  }

  function countsAll(){
    let B=0,P=0,T=0,bpPairs=0,ppPairs=0,lb=0;
    for(const h of state.hands){
      if(h.res==="B") B++; else if(h.res==="P") P++; else T++;
      if(h.bpPair) bpPairs++;
      if(h.ppPair) ppPairs++;
      if(h.long) lb++;
    }
    return {B,P,T,total:state.hands.length,bpTotal:B+P,bpPairs,ppPairs,lb};
  }

  function pct(num, den){ return den ? Math.round((num/den)*100) + "%" : "-"; }

  function cardsTotal(cards){
    let sum=0;
    for (const r of cards) sum += rankValue(r);
    return sum % 10;
  }
  function isNatural(cards){
    const t = cardsTotal(cards);
    return cards.length===2 && (t===8 || t===9);
  }
  function naturalBadge(cards){
    const t = cardsTotal(cards);
    if(cards.length===2 && (t===8 || t===9)) return {text:`Natural ${t}`, cls:"good"};
    return {text:"—", cls:"neu"};
  }

  // auto pair detection (2 lá đầu)
  function isPair2(cards){
    return cards.length>=2 && cards[0] === cards[1];
  }

  // ---------- AI ENGINE (v2)
  function aiEngine(hands){
    const last = (n) => hands.slice(Math.max(0, hands.length - n));
    const bpOnly = (arr) => arr.filter(h => h.res === 'B' || h.res === 'P');

    const w12 = bpOnly(last(12));
    const w30 = bpOnly(last(30));
    const last20 = last(20);

    const countBP = (arr) => {
      let b=0,p=0;
      for(const h of arr){ if(h.res==='B') b++; else if(h.res==='P') p++; }
      return {b,p,n:b+p};
    };
    const altRate = (arr) => {
      if(arr.length<=1) return 0;
      let changes=0;
      for(let i=1;i<arr.length;i++) if(arr[i].res !== arr[i-1].res) changes++;
      return changes/(arr.length-1); // 0..1
    };
    const entropy = (arr) => {
      const c = countBP(arr);
      if(c.n===0) return 0;
      const pB = c.b/c.n;
      const pP = c.p/c.n;
      let H=0;
      if(pB>0) H += -pB*Math.log2(pB);
      if(pP>0) H += -pP*Math.log2(pP);
      return H; // 0..1 max 1
    };
    const streakLen = (arr) => {
      if(!arr.length) return 0;
      const s = arr[arr.length-1].res;
      let len=1;
      for(let i=arr.length-2;i>=0;i--){
        if(arr[i].res===s) len++;
        else break;
      }
      return len;
    };

    const bayesPB = (c, prior=0.5, k=8) => {
      // pseudo-count smoothing to reduce % jumps
      const b = c.b + prior*k;
      const n = c.n + k;
      return n ? (b/n) : 0.5;
    };

    const c12 = countBP(w12);
    const c30 = countBP(w30);

    const pB12 = bayesPB(c12, 0.5, 8);
    const pB30 = bayesPB(c30, 0.5, 12);

    // combined probability (short more weight)
    const pB = 0.65*pB12 + 0.35*pB30;
    const edge = Math.abs(pB - 0.5); // 0..0.5

    const ent12 = entropy(w12);
    const alt12 = altRate(w12);
    const st12 = streakLen(w12);

    const tie20 = (() => {
      if(!last20.length) return 0;
      const t = last20.filter(h=>h.res==='T').length;
      return t/last20.length; // 0..1
    })();

    const shock20 = (() => {
      const w = last20;
      if(!w.length) return 0;
      let s=0;
      for(const h of w){
        if(h.long) s += 1.0;
        if(h.bpPair) s += 0.6;
        if(h.ppPair) s += 0.6;
      }
      return Math.min(1, s / (w.length*1.6));
    })();

    // noise 0..100
    let noise = 0;
    noise += ent12*42;
    noise += alt12*34;
    noise += tie20*12;
    noise += shock20*12;
    if(c12.n < 8) noise += (8 - c12.n) * 6; // small sample penalty
    noise = clamp(Math.round(noise), 0, 100);

    // confidence 0..100
    let conf = 100 - noise;
    if(c12.n >= 8) conf += 6;
    if(c12.n >= 12) conf += 6;
    if(st12 >= 4 && alt12 <= 0.45 && ent12 <= 0.78) conf += 6;
    conf = clamp(Math.round(conf), 0, 100);

    // phase
    let phase = "TRUNG TÍNH";
    if(c12.n < 8) phase = "DỮ LIỆU ÍT";
    else if(noise >= 70) phase = "TRAP (NHIỄU)";
    else if(alt12 >= 0.65 && ent12 >= 0.80) phase = "CHOP (ĐẢO)";
    else if(st12 >= 4 && alt12 <= 0.45 && ent12 <= 0.75) phase = "TREND (BÁM)";

    // lean
    const lean = (pB >= 0.535) ? 'B' : (pB <= 0.465 ? 'P' : 'NONE');

    // hard gate action
    let action = "WAIT";
    if(c12.n < 8) action = "WAIT";
    else if(conf < 45 || noise > 65 || phase.includes("TRAP")) action = "SKIP";
    else if(conf >= 62 && noise <= 52 && edge >= 0.06 && lean !== "NONE" && !phase.includes("CHOP")) action = "PLAY";
    else action = "WAIT";

    // reasons (top 4)
    const reasons = [];
    if(c12.n < 8) reasons.push("Dữ liệu B/P còn ít (cần ≥ 8)");
    if(noise > 65) reasons.push("Noise cao → dễ bẫy");
    if(ent12 >= 0.85) reasons.push("Entropy cao (loạn)");
    if(alt12 >= 0.65) reasons.push("Alt cao (đảo nhịp)");
    if(tie20 >= 0.25) reasons.push("Tie dày (nhiễu)");
    if(shock20 >= 0.35) reasons.push("Shock Pair/Long tăng");
    if(st12 >= 4) reasons.push("Có streak (nhịp bám)");
    if(edge >= 0.06) reasons.push("Edge đủ ngưỡng");
    if(lean === "B") reasons.push("Nghiêng Banker");
    if(lean === "P") reasons.push("Nghiêng Player");
    if(lean === "NONE") reasons.push("Chưa lệch rõ");

    return {
      action, phase, lean,
      conf, noise,
      edgePct: Math.round(edge*100),
      pB: Math.round(pB*100),
      pP: Math.round((1-pB)*100),
      ent12Pct: Math.round(ent12*100),
      alt12Pct: Math.round(alt12*100),
      tie20Pct: Math.round(tie20*100),
      shock20Pct: Math.round(shock20*100),
      reasons: reasons.slice(0,4)
    };
  }

  // ---------- Render
  function renderCards(elId, cards){
    const el=$(elId);
    el.innerHTML="";
    if(!cards.length){
      const d=document.createElement("div");
      d.className="cardTag";
      d.style.opacity=".65";
      d.textContent="(chưa nhập)";
      el.appendChild(d);
      return;
    }
    for(const r of cards){
      const d=document.createElement("div");
      d.className="cardTag";
      d.textContent=r;
      el.appendChild(d);
    }
  }

  function render(){
    const c = countsAll();
    $("cB").textContent=c.B;
    $("cP").textContent=c.P;
    $("cT").textContent=c.T;
    $("shoe").textContent=state.shoe;

    $("bpB").textContent = c.bpTotal ? pct(c.B, c.bpTotal) : "-";
    $("bpP").textContent = c.bpTotal ? pct(c.P, c.bpTotal) : "-";
    $("tiePct").textContent = pct(c.T, c.total);

    // last
    const h = currentHand();
    $("lastRes").textContent = h ? h.res : "-";
    $("lastBP").textContent  = h ? (h.bpPair ? "YES":"NO") : "-";
    $("lastPP").textContent  = h ? (h.ppPair ? "YES":"NO") : "-";
    $("lastLB").textContent  = h ? (h.long ? "YES":"NO") : "-";

    renderCards("cardsB", h?.cardsB || []);
    renderCards("cardsP", h?.cardsP || []);

    const totB = cardsTotal(h?.cardsB||[]);
    const totP = cardsTotal(h?.cardsP||[]);
    $("totB").textContent = String(totB);
    $("totP").textContent = String(totP);

    const nbB = naturalBadge(h?.cardsB||[]);
    const nbP = naturalBadge(h?.cardsP||[]);
    $("natB").textContent = nbB.text; $("natB").className = "badge "+nbB.cls;
    $("natP").textContent = nbP.text; $("natP").className = "badge "+nbP.cls;

    // history
    const hist=$("hist");
    hist.innerHTML="";
    const show = state.hands.slice(-120);
    for(let i=show.length-1;i>=0;i--){
      const hh=show[i];
      const d=document.createElement("div");
      d.className = "h " + (hh.res==="B"?"b":hh.res==="P"?"p":"t");
      d.textContent = hh.res;
      d.onclick=()=>{
        const idx = state.hands.length - (show.length - i);
        if(confirm("Xóa ván này?")){
          state.hands.splice(idx,1);
          save(); render();
        }
      };
      hist.appendChild(d);
    }

    // AI update
    const ai = aiEngine(state.hands);

    $("aiPhase").textContent = "PHASE: " + ai.phase;
    $("aiLean").textContent = "LEAN: " + (ai.lean==="B"?"BANKER":ai.lean==="P"?"PLAYER":"NONE");

    $("aiConf").textContent = "Conf: " + ai.conf + "%";
    $("aiNoise").textContent = "Noise: " + ai.noise + "%";
    $("aiEdge").textContent = "Edge: " + ai.edgePct + "%";

    $("aiConfVal").textContent = ai.conf + "%";
    $("aiNoiseVal").textContent = ai.noise + "%";
    $("confBar").style.width = ai.conf + "%";
    $("noiseBar").style.width = ai.noise + "%";

    $("alt12").textContent = ai.alt12Pct + "%";
    $("ent12").textContent = ai.ent12Pct + "%";
    $("shock20").textContent = ai.shock20Pct + "%";

    // Action style
    const act = ai.action;
    const actEl = $("aiActionText");
    actEl.textContent = act;

    // Put a stronger hint text
    let actionBadgeClass = "badge wait";
    if(act === "PLAY") actionBadgeClass = "badge play";
    if(act === "SKIP") actionBadgeClass = "badge skip";

    // We color phase/lean tags lightly based on action
    $("aiPhase").className = actionBadgeClass;
    $("aiLean").className  = actionBadgeClass;

    // Reasons
    const lines = [
      `B/P (smoothed): B ${ai.pB}% · P ${ai.pP}% · Edge ${ai.edgePct}%`,
      `Alt12 ${ai.alt12Pct}% · Ent12 ${ai.ent12Pct}% · Tie20 ${ai.tie20Pct}% · Shock20 ${ai.shock20Pct}%`,
      `Lý do: ${ai.reasons.join(" • ")}`
    ];
    $("aiReasons").innerHTML = `<b>Gợi ý:</b><br>${lines.map(x=>escapeHtml(x)).join("<br>")}`;
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // ---------- Dialog actions
  function openDlg(side){
    const h = currentHand();
    if(!h){
      alert("Hãy nhập 1 ván (Banker/Player/Tie) trước, rồi mới nhập lá bài cho ván đó.");
      return;
    }
    which.value = side;
    const cards = (side==="B") ? (h.cardsB||[]) : (h.cardsP||[]);
    const cc = cards.length || 2;
    cardCount.value = String(clamp(cc,2,3));
    c3.disabled = (cardCount.value==="2");
    c1.value = cards[0] || "A";
    c2.value = cards[1] || "A";
    c3.value = cards[2] || "A";
    dlgTitle.textContent = `Nhập lá bài (${side==="B"?"Banker":"Player"})`;
    dlg.showModal();
  }

  cardCount.onchange=()=>{ c3.disabled = (cardCount.value==="2"); };
  dlgCancel.onclick=()=>dlg.close();

  dlgSave.onclick=()=>{
    const h = currentHand();
    if(!h) return;

    const side = which.value;
    const n = parseInt(cardCount.value,10);
    const cards = [c1.value, c2.value];
    if(n===3) cards.push(c3.value);

    if(side==="B") h.cardsB = cards;
    else h.cardsP = cards;

    // AUTO Pair from 2 first cards
    h.bpPair = isPair2(h.cardsB || []);
    h.ppPair = isPair2(h.cardsP || []);

    // AUTO Long if either side natural 8/9
    const longNow = isNatural(h.cardsB || []) || isNatural(h.cardsP || []);
    h.long = !!longNow;

    save(); render();
    dlg.close();
  };

  // ---------- Core buttons
  function addResult(res){
    state.hands.push({
      res,
      shoe: state.shoe,
      bpPair:false,
      ppPair:false,
      long:false,
      cardsB:[],
      cardsP:[]
    });
    save(); render();
  }

  winB.onclick=()=>addResult("B");
  winP.onclick=()=>addResult("P");
  winT.onclick=()=>addResult("T");

  undo.onclick=()=>{
    state.hands.pop();
    save(); render();
  };

  reset.onclick=()=>{
    if(!confirm("Reset toàn bộ lịch sử shoe hiện tại?")) return;
    state.hands = [];
    save(); render();
  };

  newShoe.onclick=()=>{
    if(state.hands.length && !confirm("Tạo shoe mới? (không xóa lịch sử, chỉ tăng shoe)")) return;
    state.shoe += 1;
    save(); render();
  };

  exportBtn.onclick=()=>{
    const payload = {
      version: "ULTRA_AI_v2",
      exportedAt: new Date().toISOString(),
      data: state
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `bui-hao-ultra-ai-v2-shoe${state.shoe}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };

  clearBtn.onclick=()=>{
    if(!confirm("Xóa dữ liệu lưu trên máy?")) return;
    localStorage.removeItem(KEY);
    location.reload();
  };

  editB.onclick=()=>openDlg("B");
  editP.onclick=()=>openDlg("P");

  // init
  render();
})();
</script>
</body>
</html>
