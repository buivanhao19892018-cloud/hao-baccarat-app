<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hào Baccarat (C2)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --muted:#9fb0d0; --text:#e9f0ff;
      --b:#22c55e; --p:#60a5fa; --t:#fbbf24; --danger:#fb7185;
      --border:#203354; --shadow: 0 12px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #13254a 0%, var(--bg) 60%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px}
    h1{margin:0 0 6px; font-size:22px; letter-spacing:.2px}
    .sub{margin:0 0 14px; color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
      padding:14px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{
      border:0; color:#07101f; padding:10px 14px; border-radius:12px;
      font-weight:700; cursor:pointer; box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .btnB{background:var(--b)}
    .btnP{background:var(--p)}
    .btnT{background:var(--t)}
    .btnG{background:#94a3b8; color:#0b1220}
    .btnD{background:var(--danger); color:#0b1220}
    button:active{transform:translateY(1px); opacity:.92}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px;
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      border-radius:999px; color:var(--muted); font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block}
    .dotB{background:var(--b)} .dotP{background:var(--p)} .dotT{background:var(--t)}
    .muted{color:var(--muted)}
    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px}
    @media (max-width: 520px){ .kpi{grid-template-columns:1fr} }
    .k{background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:14px; padding:10px}
    .k .t{font-size:12px; color:var(--muted)}
    .k .v{font-size:18px; font-weight:800; margin-top:4px}
    .signal{
      margin-top:10px; padding:12px; border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.15);
    }
    .score{font-size:34px; font-weight:900; line-height:1; margin:0}
    .tag{display:inline-flex; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800}
    .tagGood{background:rgba(34,197,94,.15); color:#a7f3d0; border:1px solid rgba(34,197,94,.35)}
    .tagMid{background:rgba(251,191,36,.15); color:#fde68a; border:1px solid rgba(251,191,36,.35)}
    .tagBad{background:rgba(251,113,133,.12); color:#fecdd3; border:1px solid rgba(251,113,133,.35)}
    .boards{display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:12px}
    @media (max-width: 900px){ .boards{grid-template-columns:1fr} }
    .boardTitle{display:flex; justify-content:space-between; align-items:center; margin:4px 0 10px}
    .boardTitle h3{margin:0; font-size:14px; color:var(--muted); font-weight:800}
    .mini{font-size:12px; color:var(--muted)}
    .bead{
      display:grid; grid-template-columns: repeat(12, 1fr);
      gap:6px;
    }
    .cell{
      height:26px; border-radius:10px; border:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center; font-weight:900;
      background: rgba(255,255,255,.03);
    }
    .B{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35)}
    .P{background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.35)}
    .T{background: rgba(251,191,36,.16); border-color: rgba(251,191,36,.35)}
    .road{
      display:grid; grid-template-rows: repeat(6, 26px);
      grid-auto-columns: 26px;
      grid-auto-flow: column;
      gap:6px;
      overflow:auto;
      padding-bottom:4px;
    }
    .rCell{
      width:26px; height:26px; border-radius:10px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      position:relative;
    }
    .rDot{position:absolute; inset:5px; border-radius:999px}
    .rB{background: rgba(34,197,94,.9)}
    .rP{background: rgba(96,165,250,.9)}
    .tieBadge{
      position:absolute; right:-3px; bottom:-3px;
      min-width:16px; height:16px; padding:0 4px;
      border-radius:999px; font-size:11px; font-weight:900;
      display:flex; align-items:center; justify-content:center;
      background: rgba(251,191,36,.95); color:#111827;
      border:1px solid rgba(0,0,0,.25);
    }
    .hist{margin-top:10px; max-height:220px; overflow:auto; border-top:1px solid rgba(255,255,255,.08); padding-top:10px}
    .hItem{display:flex; justify-content:space-between; padding:8px 10px; border-radius:12px;
      background: rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.08); margin-bottom:8px}
    .hLeft{display:flex; gap:10px; align-items:center}
    .badge{width:28px; height:28px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:900}
    .bB{background: rgba(34,197,94,.2); border:1px solid rgba(34,197,94,.35)}
    .bP{background: rgba(96,165,250,.2); border:1px solid rgba(96,165,250,.35)}
    .bT{background: rgba(251,191,36,.18); border:1px solid rgba(251,191,36,.35)}
    .footer{margin-top:14px; color:var(--muted); font-size:12px}
    a{color:#93c5fd}
    code{color:#c7d2fe}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Hào Baccarat — C2 (Bead + Big Road + Score)</h1>
    <p class="sub">Dùng để <b>ghi lại</b> kết quả ván và xem bảng/nhịp. Lưu tự động trên máy (localStorage).</p>

    <div class="grid">
      <div class="card">
        <div class="row">
          <button class="btnB" onclick="addResult('B')">Banker</button>
          <button class="btnP" onclick="addResult('P')">Player</button>
          <button class="btnT" onclick="addResult('T')">Tie</button>
          <button class="btnG" onclick="undo()">Undo</button>
          <button class="btnD" onclick="resetAll()">Reset</button>

          <span class="pill"><span class="dot dotB"></span> B: <b id="bCount">0</b></span>
          <span class="pill"><span class="dot dotP"></span> P: <b id="pCount">0</b></span>
          <span class="pill"><span class="dot dotT"></span> T: <b id="tCount">0</b></span>
          <span class="pill">Tổng: <b id="total">0</b></span>
        </div>

        <div class="kpi">
          <div class="k"><div class="t">Streak hiện tại</div><div class="v" id="streak">-</div></div>
          <div class="k"><div class="t">Nhịp đảo (last 20)</div><div class="v" id="altRate">-</div></div>
          <div class="k"><div class="t">Tie rate (last 20)</div><div class="v" id="tieRate">-</div></div>
        </div>

        <div class="signal">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="muted" style="font-weight:800">Điểm tín hiệu (0–100)</div>
              <p class="score" id="score">0</p>
            </div>
            <div style="text-align:right">
              <div id="tag" class="tag tagMid">TRUNG TÍNH</div>
              <div class="mini" id="suggest" style="margin-top:8px">Chưa có dữ liệu.</div>
            </div>
          </div>
          <div class="footer" id="why"></div>
        </div>

        <div class="hist" id="history"></div>
      </div>

      <div class="card">
        <div class="boards">
          <div>
            <div class="boardTitle">
              <h3>Bead Plate (lịch theo ván)</h3>
              <div class="mini">Hiển thị 72 ván gần nhất</div>
            </div>
            <div class="bead" id="bead"></div>
          </div>

          <div>
            <div class="boardTitle">
              <h3>Big Road (đơn giản)</h3>
              <div class="mini">B/P là chính, Tie gắn vào ô gần nhất</div>
            </div>
            <div class="road" id="road"></div>
            <div class="footer">
              Mẹo: nếu thấy “đảo liên tục” + tie dày → điểm sẽ giảm (nhiễu).
            </div>
          </div>
        </div>

        <div class="footer">
          Ghi chú: đây là công cụ ghi & đọc nhịp, <b>không đảm bảo dự đoán</b>. Hào dùng để quản lý kỷ luật và tránh “đánh cảm xúc”.
        </div>
      </div>
    </div>
  </div>

<script>
  const KEY = "hao_baccarat_c2_v1";

  let history = JSON.parse(localStorage.getItem(KEY) || "[]"); // each: {x:'B'|'P'|'T', t:number}

  function save(){ localStorage.setItem(KEY, JSON.stringify(history)); }

  function addResult(x){
    history.push({ x, t: Date.now() });
    save();
    render();
  }

  function undo(){
    if(history.length === 0) return;
    history.pop();
    save();
    render();
  }

  function resetAll(){
    if(!confirm("Reset toàn bộ lịch sử?")) return;
    history = [];
    save();
    render();
  }

  function fmtTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString("vi-VN", {hour12:false});
    }catch(e){ return ""; }
  }

  function counts(list){
    let b=0,p=0,t=0;
    for(const it of list){
      if(it.x==='B') b++;
      else if(it.x==='P') p++;
      else t++;
    }
    return {b,p,t,total:list.length};
  }

  function lastN(n){
    return history.slice(Math.max(0, history.length - n));
  }

  function currentStreak(){
    // ignore Tie for streak identity, but tie does not break; it just sits in between
    let i = history.length - 1;
    if(i < 0) return {side:'-', len:0};
    // find last non-tie as anchor
    while(i>=0 && history[i].x==='T') i--;
    if(i<0) return {side:'T', len:history.length}; // all tie
    const side = history[i].x; // B or P
    let len = 0;
    for(let j=i; j>=0; j--){
      const x = history[j].x;
      if(x==='T') continue; // tie doesn't break
      if(x===side) len++;
      else break;
    }
    return {side, len};
  }

  function alternationRate(list){
    // consider only B/P sequence
    const bp = list.filter(it=>it.x!=='T').map(it=>it.x);
    if(bp.length<=1) return 0;
    let changes = 0;
    for(let i=1;i<bp.length;i++){
      if(bp[i]!==bp[i-1]) changes++;
    }
    return changes / (bp.length-1);
  }

  function tieRate(list){
    if(list.length===0) return 0;
    const t = list.filter(it=>it.x==='T').length;
    return t / list.length;
  }

  function dominance(list){
    const c = counts(list);
    const bp = c.b + c.p;
    if(bp===0) return {side:'-', pct:0};
    if(c.b===c.p) return {side:'=', pct:50};
    const side = (c.b>c.p) ? 'B' : 'P';
    const pct = Math.round(Math.max(c.b,c.p) / bp * 100);
    return {side, pct};
  }

  // Build Big Road (simplified classic rules)
  function buildBigRoad(){
    const rows = 6;
    const cols = []; // cols[c][r] = cell or null
    const tieCounts = []; // tieCounts[c][r] = number
    let c = 0, r = 0;

    const seq = history.map(h=>h.x);

    // helper: ensure column arrays
    function ensureCol(ci){
      while(cols.length<=ci){
        cols.push(Array(rows).fill(null));
        tieCounts.push(Array(rows).fill(0));
      }
    }

    // last placed position for tie attachment
    let lastPos = null; // {c,r}

    // last non-tie result
    let last = null;

    for(const x of seq){
      if(x==='T'){
        if(lastPos){
          tieCounts[lastPos.c][lastPos.r] = (tieCounts[lastPos.c][lastPos.r] || 0) + 1;
        }
        continue;
      }

      if(last===null){
        // first B/P
        ensureCol(0);
        cols[0][0] = x;
        last = x;
        c = 0; r = 0;
        lastPos = {c,r};
        continue;
      }

      if(x===last){
        // try go down
        let nr = r + 1;
        let nc = c;
        ensureCol(nc);

        if(nr < rows && cols[nc][nr]===null){
          r = nr;
        }else{
          // blocked: move right in same row
          nc = c + 1;
          ensureCol(nc);
          // find first free column at same row
          while(cols[nc][r]!==null){
            nc++;
            ensureCol(nc);
          }
          c = nc;
        }
        cols[c][r] = x;
        lastPos = {c,r};
      }else{
        // change: new column to the right, row 0
        let nc = c + 1;
        ensureCol(nc);
        // find first free at row 0
        while(cols[nc][0]!==null){
          nc++;
          ensureCol(nc);
        }
        c = nc; r = 0;
        cols[c][r] = x;
        last = x;
        lastPos = {c,r};
      }
    }

    return {cols, tieCounts, rows};
  }

  function scoreSignal(){
    const L20 = lastN(20);
    const L50 = lastN(50);
    const st = currentStreak();
    const alt = alternationRate(L20);
    const tr = tieRate(L20);
    const dom20 = dominance(L20);
    const dom50 = dominance(L50);

    let score = 50;
    const reasons = [];

    // streak weight
    if(st.side==='B' || st.side==='P'){
      if(st.len>=6){ score += 20; reasons.push(`Streak ${st.side} mạnh (${st.len})`); }
      else if(st.len>=4){ score += 14; reasons.push(`Streak ${st.side} rõ (${st.len})`); }
      else if(st.len>=3){ score += 9; reasons.push(`Streak ${st.side} vừa (${st.len})`); }
      else if(st.len===2){ score += 3; reasons.push(`Streak ${st.side} nhẹ (2)`); }
      else reasons.push(`Streak yếu`);
    }else{
      reasons.push(`Nhiều Tie / chưa có B/P rõ`);
    }

    // dominance
    if(dom20.side==='B' || dom20.side==='P'){
      if(dom20.pct>=72){ score += 12; reasons.push(`L20 nghiêng ${dom20.side} (${dom20.pct}%)`); }
      else if(dom20.pct>=65){ score += 8; reasons.push(`L20 hơi nghiêng ${dom20.side} (${dom20.pct}%)`); }
      else if(dom20.pct<=55){ score -= 6; reasons.push(`L20 cân / khó đọc`); }
    }

    // alternation penalty
    if(alt>=0.65){ score -= 18; reasons.push(`Đảo nhiều (alt ${(alt*100)|0}%)`); }
    else if(alt>=0.55){ score -= 10; reasons.push(`Đảo vừa (alt ${(alt*100)|0}%)`); }
    else if(alt<=0.35){ score += 6; reasons.push(`Nhịp ổn (alt ${(alt*100)|0}%)`); }

    // tie density penalty
    if(tr>=0.25){ score -= 12; reasons.push(`Tie dày (tie ${(tr*100)|0}%)`); }
    else if(tr>=0.18){ score -= 7; reasons.push(`Tie tương đối (tie ${(tr*100)|0}%)`); }

    // longer window sanity
    if(dom50.side===dom20.side && (dom50.side==='B'||dom50.side==='P') && dom50.pct>=62){
      score += 5;
      reasons.push(`L50 cùng hướng (${dom50.side} ${dom50.pct}%)`);
    }

    score = Math.max(0, Math.min(100, Math.round(score)));

    // suggestion text (neutral wording)
    let tag = "TRUNG TÍNH", tagClass="tagMid", suggest="Quan sát thêm 1–2 ván để xác nhận.";
    if(score>=70){
      tag="TÍN HIỆU TỐT"; tagClass="tagGood";
      let side = dom20.side;
      if(st.side==='B'||st.side==='P') side = st.side;
      suggest = `Xu hướng đang nghiêng về ${side} (ưu tiên đọc theo streak/dominance, tránh đổi tay vội).`;
    }else if(score<=45){
      tag="NHIỄU / CẨN THẬN"; tagClass="tagBad";
      suggest = `Nhịp nhiễu (đảo/tie). Ưu tiên dừng hoặc chờ mẫu rõ hơn.`;
    }

    return {score, reasons, tag, tagClass, suggest, st, alt, tr};
  }

  function render(){
    // counts
    const c = counts(history);
    document.getElementById("bCount").textContent = c.b;
    document.getElementById("pCount").textContent = c.p;
    document.getElementById("tCount").textContent = c.t;
    document.getElementById("total").textContent = c.total;

    // KPIs
    const st = currentStreak();
    const stTxt = (st.side==='B'||st.side==='P') ? `${st.side} × ${st.len}` : (st.side==='T' ? `T × ${st.len}` : "-");
    document.getElementById("streak").textContent = stTxt;

    const L20 = lastN(20);
    const alt = alternationRate(L20);
    const tr = tieRate(L20);
    document.getElementById("altRate").textContent = (L20.length<3) ? "-" : `${Math.round(alt*100)}%`;
    document.getElementById("tieRate").textContent = (L20.length<3) ? "-" : `${Math.round(tr*100)}%`;

    // score
    const sig = scoreSignal();
    document.getElementById("score").textContent = sig.score;
    const tagEl = document.getElementById("tag");
    tagEl.textContent = sig.tag;
    tagEl.className = `tag ${sig.tagClass}`;
    document.getElementById("suggest").textContent = sig.suggest;
    document.getElementById("why").textContent = sig.reasons.join(" • ");

    // bead plate (72)
    const bead = document.getElementById("bead");
    bead.innerHTML = "";
    const last72 = history.slice(Math.max(0, history.length-72));
    for(const it of last72){
      const d = document.createElement("div");
      d.className = `cell ${it.x}`;
      d.textContent = it.x;
      bead.appendChild(d);
    }
    // fill empty slots for stable grid look
    const empty = 72 - last72.length;
    for(let i=0;i<empty;i++){
      const d = document.createElement("div");
      d.className = "cell";
      d.textContent = "";
      bead.appendChild(d);
    }

    // big road
    const road = document.getElementById("road");
    road.innerHTML = "";
    const br = buildBigRoad();
    // render by columns then rows
    const cols = br.cols;
    const ties = br.tieCounts;
    for(let ci=0; ci<cols.length; ci++){
      for(let ri=0; ri<br.rows; ri++){
        const v = cols[ci][ri];
        const cell = document.createElement("div");
        cell.className = "rCell";
        if(v==='B' || v==='P'){
          const dot = document.createElement("div");
          dot.className = `rDot ${v==='B' ? 'rB' : 'rP'}`;
          cell.appendChild(dot);

          const tcount = ties[ci][ri] || 0;
          if(tcount>0){
            const badge = document.createElement("div");
            badge.className = "tieBadge";
            badge.textContent = tcount>9 ? "9+" : String(tcount);
            cell.appendChild(badge);
          }
        }
        road.appendChild(cell);
      }
    }

    // history list
    const h = document.getElementById("history");
    h.innerHTML = "";
    const last = history.slice().reverse().slice(0, 30);
    if(last.length===0){
      h.innerHTML = `<div class="muted">Chưa có lịch sử. Bấm Banker/Player/Tie để bắt đầu.</div>`;
    }else{
      last.forEach((it, idx)=>{
        const item = document.createElement("div");
        item.className = "hItem";
        const left = document.createElement("div");
        left.className = "hLeft";
        const badge = document.createElement("div");
        badge.className = `badge ${it.x==='B'?'bB':it.x==='P'?'bP':'bT'}`;
        badge.textContent = it.x;

        const meta = document.createElement("div");
        meta.innerHTML = `<div style="font-weight:900">#${history.length-idx}</div>
                          <div class="muted" style="font-size:12px">${fmtTime(it.t)}</div>`;
        left.appendChild(badge);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.className="muted";
        right.textContent = (it.x==='B'?'Banker':it.x==='P'?'Player':'Tie');

        item.appendChild(left);
        item.appendChild(right);
        h.appendChild(item);
      });
    }
  }

  render();
</script>
</body>
</html>
